@using AgarIA.Core.Data.Models
@model GameSettings

<form asp-action="Update">
    <div class="grid grid-cols-12 gap-4">
        <!-- Left column: Game settings -->
        <div class="col-span-12 lg:col-span-7">
            <!-- AI Players card -->
            <div class="card bg-base-100 border border-base-200 mb-3">
                <div class="card-body p-3">
                    <h3 class="font-semibold text-sm">Heuristic AI Players</h3>
                    <p class="text-xs text-base-content/60 mb-2">Internal heuristic bots managed by the .NET server.</p>
                    <div class="grid grid-cols-2 gap-2">
                        <fieldset class="fieldset">
                            <legend class="fieldset-legend">Min Players</legend>
                            <input type="number" asp-for="MinAIPlayers" class="input input-sm w-full" min="0" max="500" />
                        </fieldset>
                        <fieldset class="fieldset">
                            <legend class="fieldset-legend">Max Players</legend>
                            <input type="number" asp-for="MaxAIPlayers" class="input input-sm w-full" min="0" max="500" />
                        </fieldset>
                    </div>
                </div>
            </div>

            <!-- Heuristic Players card -->
            <div class="card bg-base-100 border border-base-200 mb-3" id="heuristicCard">
                <div class="card-body p-3">
                    <h3 class="font-semibold text-sm">Named Heuristic Players</h3>
                    <label class="label cursor-pointer justify-start gap-3 mb-1">
                        <input type="checkbox" name="heuristicEnabled" value="true" class="checkbox checkbox-xs"
                               @(Model.HeuristicEnabled ? "checked" : "") id="heuristicEnabledCb" />
                        <span class="label-text">Enabled</span>
                    </label>
                    <div class="grid grid-cols-2 gap-2">
                        <fieldset class="fieldset">
                            <legend class="fieldset-legend">Count</legend>
                            <input type="number" name="heuristicPlayerCount" class="input input-sm w-full"
                                   min="0" max="50" value="@Model.HeuristicPlayerCount" />
                        </fieldset>
                        <fieldset class="fieldset">
                            <legend class="fieldset-legend">Can Eat Each Other</legend>
                            <label class="label cursor-pointer justify-start gap-2">
                                <input type="checkbox" name="heuristicCanEatEachOther" value="true" class="checkbox checkbox-xs"
                                       @(Model.HeuristicCanEatEachOther ? "checked" : "") />
                                <span class="label-text text-xs">Allow cannibalism</span>
                            </label>
                        </fieldset>
                    </div>
                </div>
            </div>

            <!-- Game Reset card -->
            <div class="card bg-base-100 border border-base-200 mb-3">
                <div class="card-body p-3">
                    <h3 class="font-semibold text-sm">Game Reset</h3>
                    <p class="text-xs text-base-content/60 mb-2">Configure when the game resets and a new round begins.</p>

                    <fieldset class="fieldset mb-2">
                        <legend class="fieldset-legend">Reset Type</legend>
                        <div class="flex flex-wrap gap-4">
                            @foreach (var rt in Enum.GetValues<ResetType>())
                            {
                                <label class="label cursor-pointer gap-2">
                                    <input type="radio" name="ResetType" value="@rt" class="radio radio-xs"
                                           checked="@(Model.ResetType == rt)" data-reset-type="@rt" />
                                    <span class="label-text">@rt</span>
                                </label>
                            }
                        </div>
                    </fieldset>

                    <div class="grid grid-cols-2 gap-2">
                        <fieldset class="fieldset reset-field" data-for="MaxScore">
                            <legend class="fieldset-legend">Reset at Score</legend>
                            <input type="number" asp-for="ResetAtScore" class="input input-sm w-full" min="100" step="100" />
                        </fieldset>
                        <fieldset class="fieldset reset-field" data-for="MaxTime">
                            <legend class="fieldset-legend">Min Reset (seconds)</legend>
                            <input type="number" asp-for="MinResetSeconds" class="input input-sm w-full" min="0" />
                        </fieldset>
                        <fieldset class="fieldset reset-field" data-for="MaxTime">
                            <legend class="fieldset-legend">Max Reset (seconds)</legend>
                            <input type="number" asp-for="MaxResetSeconds" class="input input-sm w-full" min="0" />
                        </fieldset>
                    </div>
                </div>
            </div>

            <!-- Python AI Sidecar info -->
            <div class="card bg-base-100 border border-base-200 mb-3">
                <div class="card-body p-3">
                    <h3 class="font-semibold text-sm">Python AI Sidecar</h3>
                    <p class="text-xs text-base-content/60 mb-2">AI training is handled by an external Python process via REST API. See <code>python-ai/README.md</code> for setup.</p>
                    <div class="text-xs font-mono text-base-content/50">
                        <div>GET /api/ai/state — Game state</div>
                        <div>GET /api/ai/config — Game constants</div>
                        <div>POST /api/ai/players — Register bots</div>
                        <div>DELETE /api/ai/players — Remove bots</div>
                        <div>POST /api/ai/actions — Send actions</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right column: Speed + actions -->
        <div class="col-span-12 lg:col-span-5">
            <!-- Simulation card -->
            <div class="card bg-base-100 border border-base-200 mb-3">
                <div class="card-body p-3">
                    <h3 class="font-semibold text-sm">Simulation</h3>
                    <label class="label cursor-pointer justify-start gap-3">
                        <input type="checkbox" asp-for="MaxSpeed" class="checkbox checkbox-xs" />
                        <span class="label-text">Max Speed</span>
                    </label>
                    <p class="text-xs text-base-content/60 mt-1">Run without tick delay for faster training.</p>
                </div>
            </div>

            <!-- Danger Zone card -->
            <div class="card bg-base-100 border border-error/30 mb-3">
                <div class="card-body p-3">
                    <h3 class="font-semibold text-sm text-error">Danger Zone</h3>
                    <p class="text-xs text-base-content/60 mb-2">Force an immediate game reset. All bots respawn and a new round begins.</p>
                    <button type="button" id="resetGameBtn" class="btn btn-error btn-sm btn-outline">
                        Reset Game Now
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Save button -->
    <div class="flex justify-end mt-2">
        <button class="btn btn-neutral" type="submit">Save Settings</button>
    </div>
</form>

<!-- Separate form for game reset to avoid mixing with settings update -->
<form id="resetGameForm" asp-action="ResetGame" style="display:none"></form>

<script>
    // Toggle visibility of reset-specific fields based on selected reset type
    function updateResetFields() {
        const selected = document.querySelector('input[name="ResetType"]:checked')?.value;
        document.querySelectorAll('.reset-field').forEach(el => {
            el.style.display = el.dataset.for === selected ? '' : 'none';
        });
    }

    document.querySelectorAll('input[name="ResetType"]').forEach(r =>
        r.addEventListener('change', updateResetFields));
    updateResetFields();

    // Toggle heuristic card opacity based on enabled checkbox
    const heuristicCb = document.getElementById('heuristicEnabledCb');
    const heuristicCard = document.getElementById('heuristicCard');
    heuristicCb.addEventListener('change', () => {
        heuristicCard.style.opacity = heuristicCb.checked ? '' : '0.7';
    });
    if (!heuristicCb.checked) heuristicCard.style.opacity = '0.7';

    // Confirm before resetting game
    document.getElementById('resetGameBtn').addEventListener('click', () => {
        if (confirm('Reset the game now? All bots will respawn.')) {
            document.getElementById('resetGameForm').submit();
        }
    });
</script>
