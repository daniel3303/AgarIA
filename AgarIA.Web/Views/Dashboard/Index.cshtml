@model AgarIA.Web.ViewModels.DashboardViewModel

<!-- Live game stats cards -->
<div id="stats-cards" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
    <div class="stat bg-base-100 shadow rounded-box">
        <div class="stat-title">Game Speed</div>
        <div class="stat-value text-lg">
            <span id="stat-multiplier">@Model.SpeedMultiplier.ToString("0.#")</span>x speed
            @if (Model.MaxSpeed) {
                <span class="badge badge-warning badge-xs ml-1">MAX</span>
            }
        </div>
        <div class="stat-desc">
            <span id="stat-tps">@Model.TicksPerSecond</span> TPS
        </div>
    </div>
    <div class="stat bg-base-100 shadow rounded-box">
        <div class="stat-title">Current Tick</div>
        <div class="stat-value text-lg" id="stat-tick">@Model.CurrentTick</div>
    </div>
    <div class="stat bg-base-100 shadow rounded-box">
        <div class="stat-title">Total Players</div>
        <div class="stat-value text-lg" id="stat-players">@Model.TotalPlayers</div>
        <div class="stat-desc"><span id="stat-human">@Model.HumanPlayers</span> human / <span id="stat-ai">@Model.AiPlayers</span> AI</div>
    </div>
    <div class="stat bg-base-100 shadow rounded-box">
        <div class="stat-title">Food Items</div>
        <div class="stat-value text-lg" id="stat-food">@Model.FoodCount</div>
    </div>
    <div class="stat bg-base-100 shadow rounded-box">
        <div class="stat-title">Top Score</div>
        <div class="stat-value text-lg" id="stat-score">@Model.TopScore</div>
    </div>
    <div class="stat bg-base-100 shadow rounded-box">
        <div class="stat-title">Spectators</div>
        <div class="stat-value text-lg" id="stat-spectators">@Model.Spectators</div>
    </div>
</div>

<!-- PPO Training Stats -->
<h3 class="text-lg font-bold mb-4">PPO Training</h3>
<div class="grid grid-cols-3 gap-4 mb-6">
    @foreach (var tier in new[] { "easy", "medium", "hard" }) {
        var label = tier[0..1].ToUpper() + tier[1..];
        <div class="card bg-base-100 shadow-sm">
            <div class="card-body p-4">
                <h3 class="card-title text-base">@label</h3>
                <div class="grid grid-cols-2 gap-x-4 gap-y-1 text-sm">
                    <span class="text-base-content/60">Updates</span>
                    <span class="font-mono text-right" id="ppo-@tier-updates">—</span>
                    <span class="text-base-content/60">Avg Reward</span>
                    <span class="font-mono text-right" id="ppo-@tier-reward">—</span>
                    <span class="text-base-content/60">Policy Loss</span>
                    <span class="font-mono text-right" id="ppo-@tier-ploss">—</span>
                    <span class="text-base-content/60">Value Loss</span>
                    <span class="font-mono text-right" id="ppo-@tier-vloss">—</span>
                    <span class="text-base-content/60">Entropy</span>
                    <span class="font-mono text-right" id="ppo-@tier-entropy">—</span>
                    <span class="text-base-content/60">Buffer</span>
                    <span class="font-mono text-right" id="ppo-@tier-buffer">—</span>
                </div>
            </div>
        </div>
    }
</div>

<!-- Win rate cards for last 100 games -->
<h3 class="text-lg font-bold mb-4">Win Rates (Last 100 Games)</h3>
<div id="winrate-cards" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
    <div class="stat bg-base-100 shadow rounded-box">
        <div class="stat-title">Easy</div>
        <div class="stat-value text-lg" id="wr-easy-pct">—</div>
        <div class="stat-desc"><span id="wr-easy-wins">0</span> wins</div>
    </div>
    <div class="stat bg-base-100 shadow rounded-box">
        <div class="stat-title">Medium</div>
        <div class="stat-value text-lg" id="wr-medium-pct">—</div>
        <div class="stat-desc"><span id="wr-medium-wins">0</span> wins</div>
    </div>
    <div class="stat bg-base-100 shadow rounded-box">
        <div class="stat-title">Hard</div>
        <div class="stat-value text-lg" id="wr-hard-pct">—</div>
        <div class="stat-desc"><span id="wr-hard-wins">0</span> wins</div>
    </div>
    <div class="stat bg-base-100 shadow rounded-box">
        <div class="stat-title">Human</div>
        <div class="stat-value text-lg" id="wr-human-pct">—</div>
        <div class="stat-desc"><span id="wr-human-wins">0</span> wins</div>
    </div>
</div>

<!-- Recent rounds -->
@if (Model.RecentRounds.Any()) {
    <h3 class="text-lg font-bold mt-8 mb-4">Recent Rounds</h3>
    <div class="overflow-x-auto">
        <table class="table table-zebra">
            <thead>
                <tr>
                    <th>Ended</th>
                    <th>Duration</th>
                    <th>Players</th>
                    <th>Total Mass</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var round in Model.RecentRounds) {
                    <tr>
                        <td>@round.EndedAt.ToString("g")</td>
                        <td>@TimeSpan.FromSeconds(round.DurationTicks / 20.0).ToString(@"mm\:ss")</td>
                        <td>@round.PlayerCount (@round.AiPlayerCount AI)</td>
                        <td>@((int)round.TotalMass)</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}

@section Scripts {
    <script>
        // Auto-refresh dashboard stats every 2 seconds without full page reload
        (function () {
            const statsUrl = '@Url.Action("Stats")';

            async function refreshStats() {
                try {
                    const res = await fetch(statsUrl);
                    if (!res.ok) return;
                    const d = await res.json();

                    // Update stat card values
                    document.getElementById('stat-tps').textContent = d.ticksPerSecond;
                    document.getElementById('stat-multiplier').textContent = d.speedMultiplier;
                    document.getElementById('stat-tick').textContent = d.currentTick;
                    document.getElementById('stat-players').textContent = d.totalPlayers;
                    document.getElementById('stat-human').textContent = d.humanPlayers;
                    document.getElementById('stat-ai').textContent = d.aiPlayers;
                    document.getElementById('stat-food').textContent = d.foodCount;
                    document.getElementById('stat-score').textContent = d.topScore;
                    document.getElementById('stat-spectators').textContent = d.spectators;
                    // Update PPO training stat cards
                    if (d.ppoStats) {
                        updatePpoCard('easy', d.ppoStats.easy);
                        updatePpoCard('medium', d.ppoStats.medium);
                        updatePpoCard('hard', d.ppoStats.hard);
                    }
                    // Update win rate cards
                    if (d.winRates) {
                        updateWinRate('easy', d.winRates.easy);
                        updateWinRate('medium', d.winRates.medium);
                        updateWinRate('hard', d.winRates.hard);
                        updateWinRate('human', d.winRates.human);
                    }
                } catch (e) {
                    // Silently ignore fetch errors
                }
            }

            // Update a PPO training stat card for a given tier
            function updatePpoCard(tier, data) {
                if (!data) return;
                var el = function(suffix) { return document.getElementById('ppo-' + tier + '-' + suffix); };
                el('updates').textContent = data.totalUpdates || 0;
                el('reward').textContent = (data.avgReward || 0).toFixed(3);
                el('ploss').textContent = (data.policyLoss || 0).toFixed(4);
                el('vloss').textContent = (data.valueLoss || 0).toFixed(4);
                el('entropy').textContent = (data.entropy || 0).toFixed(3);
                el('buffer').textContent = data.bufferFill || 0;
            }

            // Update a win rate stat card with wins count and percentage
            function updateWinRate(key, data) {
                document.getElementById('wr-' + key + '-pct').textContent = data.pct + '%';
                document.getElementById('wr-' + key + '-wins').textContent = data.wins;
            }

            setInterval(refreshStats, 2000);
        })();
    </script>
}
