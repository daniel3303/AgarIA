@model AgarIA.Web.ViewModels.DashboardViewModel

<!-- Live game stats cards -->
<div id="stats-cards" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
    <div class="stat bg-base-100 shadow rounded-box">
        <div class="stat-title">Game Speed</div>
        <div class="stat-value text-lg">
            <span id="stat-multiplier">@Model.SpeedMultiplier.ToString("0.#")</span>x speed
            @if (Model.MaxSpeed) {
                <span class="badge badge-warning badge-xs ml-1">MAX</span>
            }
        </div>
        <div class="stat-desc">
            <span id="stat-tps">@Model.TicksPerSecond</span> TPS
        </div>
    </div>
    <div class="stat bg-base-100 shadow rounded-box">
        <div class="stat-title">Current Tick</div>
        <div class="stat-value text-lg" id="stat-tick">@Model.CurrentTick</div>
    </div>
    <div class="stat bg-base-100 shadow rounded-box">
        <div class="stat-title">Total Players</div>
        <div class="stat-value text-lg" id="stat-players">@Model.TotalPlayers</div>
        <div class="stat-desc"><span id="stat-human">@Model.HumanPlayers</span> human / <span id="stat-ai">@Model.AiPlayers</span> AI</div>
    </div>
    <div class="stat bg-base-100 shadow rounded-box">
        <div class="stat-title">Food Items</div>
        <div class="stat-value text-lg" id="stat-food">@Model.FoodCount</div>
    </div>
    <div class="stat bg-base-100 shadow rounded-box">
        <div class="stat-title">Top Score</div>
        <div class="stat-value text-lg" id="stat-score">@Model.TopScore</div>
    </div>
    <div class="stat bg-base-100 shadow rounded-box">
        <div class="stat-title">Spectators</div>
        <div class="stat-value text-lg" id="stat-spectators">@Model.Spectators</div>
    </div>
</div>

<!-- Genome fitness tables -->
<div class="grid grid-cols-3 gap-4 mb-6">
    <!-- Easy pool -->
    <div class="card bg-base-100 shadow-sm">
        <div class="card-body p-4">
            <h3 class="card-title text-base">Easy</h3>
            <div id="fitness-easy-empty" class="text-base-content/50 text-sm py-4 text-center">No data yet</div>
            <table id="fitness-easy-table" class="table table-zebra table-sm hidden">
                <thead>
                    <tr>
                        <th class="w-12">#</th>
                        <th>Fitness Score</th>
                    </tr>
                </thead>
                <tbody id="fitness-easy-body"></tbody>
            </table>
            <div id="fitness-easy-summary" class="text-sm text-base-content/70 mt-2 hidden"></div>
        </div>
    </div>
    <!-- Medium pool -->
    <div class="card bg-base-100 shadow-sm">
        <div class="card-body p-4">
            <h3 class="card-title text-base">Medium</h3>
            <div id="fitness-medium-empty" class="text-base-content/50 text-sm py-4 text-center">No data yet</div>
            <table id="fitness-medium-table" class="table table-zebra table-sm hidden">
                <thead>
                    <tr>
                        <th class="w-12">#</th>
                        <th>Fitness Score</th>
                    </tr>
                </thead>
                <tbody id="fitness-medium-body"></tbody>
            </table>
            <div id="fitness-medium-summary" class="text-sm text-base-content/70 mt-2 hidden"></div>
        </div>
    </div>
    <!-- Hard pool -->
    <div class="card bg-base-100 shadow-sm">
        <div class="card-body p-4">
            <h3 class="card-title text-base">Hard</h3>
            <div id="fitness-hard-empty" class="text-base-content/50 text-sm py-4 text-center">No data yet</div>
            <table id="fitness-hard-table" class="table table-zebra table-sm hidden">
                <thead>
                    <tr>
                        <th class="w-12">#</th>
                        <th>Fitness Score</th>
                    </tr>
                </thead>
                <tbody id="fitness-hard-body"></tbody>
            </table>
            <div id="fitness-hard-summary" class="text-sm text-base-content/70 mt-2 hidden"></div>
        </div>
    </div>
</div>

<!-- Win rate cards for last 100 games -->
<h3 class="text-lg font-bold mb-4">Win Rates (Last 100 Games)</h3>
<div id="winrate-cards" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
    <div class="stat bg-base-100 shadow rounded-box">
        <div class="stat-title">Easy</div>
        <div class="stat-value text-lg" id="wr-easy-pct">—</div>
        <div class="stat-desc"><span id="wr-easy-wins">0</span> wins</div>
    </div>
    <div class="stat bg-base-100 shadow rounded-box">
        <div class="stat-title">Medium</div>
        <div class="stat-value text-lg" id="wr-medium-pct">—</div>
        <div class="stat-desc"><span id="wr-medium-wins">0</span> wins</div>
    </div>
    <div class="stat bg-base-100 shadow rounded-box">
        <div class="stat-title">Hard</div>
        <div class="stat-value text-lg" id="wr-hard-pct">—</div>
        <div class="stat-desc"><span id="wr-hard-wins">0</span> wins</div>
    </div>
    <div class="stat bg-base-100 shadow rounded-box">
        <div class="stat-title">Human</div>
        <div class="stat-value text-lg" id="wr-human-pct">—</div>
        <div class="stat-desc"><span id="wr-human-wins">0</span> wins</div>
    </div>
</div>

<!-- Recent rounds -->
@if (Model.RecentRounds.Any()) {
    <h3 class="text-lg font-bold mt-8 mb-4">Recent Rounds</h3>
    <div class="overflow-x-auto">
        <table class="table table-zebra">
            <thead>
                <tr>
                    <th>Ended</th>
                    <th>Duration</th>
                    <th>Players</th>
                    <th>Total Mass</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var round in Model.RecentRounds) {
                    <tr>
                        <td>@round.EndedAt.ToString("g")</td>
                        <td>@TimeSpan.FromSeconds(round.DurationTicks / 20.0).ToString(@"mm\:ss")</td>
                        <td>@round.PlayerCount (@round.AiPlayerCount AI)</td>
                        <td>@((int)round.TotalMass)</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}

@section Scripts {
    <script>
        // Auto-refresh dashboard stats every 2 seconds without full page reload
        (function () {
            const statsUrl = '@Url.Action("Stats")';

            async function refreshStats() {
                try {
                    const res = await fetch(statsUrl);
                    if (!res.ok) return;
                    const d = await res.json();

                    // Update stat card values
                    document.getElementById('stat-tps').textContent = d.ticksPerSecond;
                    document.getElementById('stat-multiplier').textContent = d.speedMultiplier;
                    document.getElementById('stat-tick').textContent = d.currentTick;
                    document.getElementById('stat-players').textContent = d.totalPlayers;
                    document.getElementById('stat-human').textContent = d.humanPlayers;
                    document.getElementById('stat-ai').textContent = d.aiPlayers;
                    document.getElementById('stat-food').textContent = d.foodCount;
                    document.getElementById('stat-score').textContent = d.topScore;
                    document.getElementById('stat-spectators').textContent = d.spectators;
                    // Update fitness tables for each pool
                    if (d.fitnessStats) {
                        updateFitnessTable('easy', d.fitnessStats.easy);
                        updateFitnessTable('medium', d.fitnessStats.medium);
                        updateFitnessTable('hard', d.fitnessStats.hard);
                    }
                    // Update win rate cards
                    if (d.winRates) {
                        updateWinRate('easy', d.winRates.easy);
                        updateWinRate('medium', d.winRates.medium);
                        updateWinRate('hard', d.winRates.hard);
                        updateWinRate('human', d.winRates.human);
                    }
                } catch (e) {
                    // Silently ignore fetch errors
                }
            }

            // Populate a fitness pool table with top-10 scores and summary stats
            function updateFitnessTable(pool, data) {
                var empty = document.getElementById('fitness-' + pool + '-empty');
                var table = document.getElementById('fitness-' + pool + '-table');
                var body = document.getElementById('fitness-' + pool + '-body');
                var summary = document.getElementById('fitness-' + pool + '-summary');

                if (!data) {
                    empty.classList.remove('hidden');
                    table.classList.add('hidden');
                    summary.classList.add('hidden');
                    return;
                }

                empty.classList.add('hidden');
                table.classList.remove('hidden');
                summary.classList.remove('hidden');

                body.innerHTML = data.top10.map(function (score, i) {
                    return '<tr><td>' + (i + 1) + '</td><td>' + score.toFixed(1) + '</td></tr>';
                }).join('');

                summary.textContent = 'Avg: ' + data.average.toFixed(1)
                    + ' · Median: ' + data.median.toFixed(1)
                    + ' · Pool: ' + data.poolSize;
            }

            // Update a win rate stat card with wins count and percentage
            function updateWinRate(key, data) {
                document.getElementById('wr-' + key + '-pct').textContent = data.pct + '%';
                document.getElementById('wr-' + key + '-wins').textContent = data.wins;
            }

            setInterval(refreshStats, 2000);
        })();
    </script>
}
